"use strict";
var core_1 = require("@angular/core");
var config_1 = require("../config");
var Sqlite = require("nativescript-sqlite");
var UserDao = (function () {
    function UserDao() {
        var _this = this;
        if (!this.isInstantiated) {
            (new Sqlite(config_1.Config.databaseName)).then(function (db) {
                db.execSQL("CREATE TABLE IF NOT EXISTS user (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT,\n                            emailAddress TEXT, password TEXT, firstname TEXT, lastname TEXT, roleId INTEGER,\n                            FOREIGN KEY(roleId) REFERENCES role(id))\n                ").then(function (id) {
                    _this.database = db;
                    _this.isInstantiated = true;
                }, function (error) {
                    console.log("CREATE TABLE ERROR", error);
                });
            }, function (error) {
                console.log("OPEN DB ERROR", error);
            });
        }
    }
    UserDao.prototype.insert = function (user) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.database.execSQL("INSERT INTO user (username, emailAddress, password, firstname, lastname) VALUES (?, ?, ?, ?, ?)", [user.username, user.emailAddress, user.password, user.firstname, user.lastname])
                .then(function (id) {
                console.log("INSERT RESULT", id);
                resolve(_this.fetchUserById(id));
            }, function (error) {
                console.log("INSERT ERROR", error);
            });
        });
    };
    UserDao.prototype.fetchUserById = function (id) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.database.all("SELECT * FROM user where id = ?", [id]).then(function (rows) {
                var users = [];
                for (var row in rows) {
                    users.push({
                        "id": rows[row][0],
                        "firstname": rows[row][1],
                        "lastname": rows[row][2]
                    });
                }
                resolve(users);
            }, function (error) {
                reject(error);
            });
        });
    };
    UserDao.prototype.fetchUserByEmailAddress = function (user) {
        var _this = this;
        console.log(user.emailAddress);
        console.log(user.username);
        console.log(user.password);
        return new Promise(function (resolve, reject) {
            _this.database.all("SELECT id, firstname, lastname, username, emailAddress FROM user where emailAddress = ?", [user.emailAddress]).then(function (rows) {
                var users = [];
                for (var row in rows) {
                    users.push({
                        "id": rows[row][0],
                        "firstname": rows[row][1],
                        "lastname": rows[row][2],
                        "username": rows[row][3],
                        "emailAddress": rows[row][4]
                    });
                }
                console.log("IM HERE");
                if (users.length > 0) {
                    resolve(users);
                }
                else {
                    reject(null);
                }
            }, function (error) {
                console.log("IM HERE REJECTED");
                reject(null);
            });
        });
    };
    UserDao.prototype.fetchUser = function (user) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.database.all("SELECT id, firstname, lastname, username, emailAddress FROM user where (emailAddress = ?) AND password = ?", [user.emailAddress, user.password]).then(function (rows) {
                var users = [];
                for (var row in rows) {
                    users.push({
                        "id": rows[row][0],
                        "firstname": rows[row][1],
                        "lastname": rows[row][2],
                        "username": rows[row][3],
                        "emailAddress": rows[row][4]
                    });
                }
                if (users.length > 0) {
                    resolve(users);
                }
                else {
                    reject(null);
                }
            }, function (error) {
                reject(null);
            });
        });
    };
    UserDao.prototype.fetchAll = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.database.all("SELECT id, firstname, lastname, username, emailAddress FROM user").then(function (rows) {
                var users = [];
                for (var row in rows) {
                    users.push({
                        "id": rows[row][0],
                        "firstname": rows[row][1],
                        "lastname": rows[row][2],
                        "username": rows[row][3],
                        "emailAddress": rows[row][4],
                    });
                }
                resolve(users);
            }, function (error) {
                console.log("SELECT ERROR", error);
                reject([]);
            });
        });
    };
    return UserDao;
}());
UserDao = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [])
], UserDao);
exports.UserDao = UserDao;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci5kYW8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ1c2VyLmRhby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0Esc0NBQTJDO0FBRTNDLG9DQUFtQztBQUVuQyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUc1QyxJQUFhLE9BQU87SUFLaEI7UUFBQSxpQkFnQkM7UUFmRyxFQUFFLENBQUEsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLENBQUMsSUFBSSxNQUFNLENBQUMsZUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUEsRUFBRTtnQkFDckMsRUFBRSxDQUFDLE9BQU8sQ0FBQyw2UkFHVixDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUEsRUFBRTtvQkFDTixLQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztvQkFDbkIsS0FBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7Z0JBQy9CLENBQUMsRUFBRSxVQUFBLEtBQUs7b0JBQ0osT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDN0MsQ0FBQyxDQUFDLENBQUM7WUFDUCxDQUFDLEVBQUUsVUFBQSxLQUFLO2dCQUNKLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3hDLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztJQUNMLENBQUM7SUFFTSx3QkFBTSxHQUFiLFVBQWMsSUFBVTtRQUF4QixpQkFXQztRQVZHLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBQy9CLEtBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLGlHQUFpRyxFQUNuRyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2lCQUNwRyxJQUFJLENBQUMsVUFBQSxFQUFFO2dCQUNKLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUNqQyxPQUFPLENBQUMsS0FBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLENBQUMsRUFBRSxVQUFBLEtBQUs7Z0JBQ0osT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdkMsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTSwrQkFBYSxHQUFwQixVQUFxQixFQUFPO1FBQTVCLGlCQWdCQztRQWZHLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBQ25DLEtBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGlDQUFpQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQSxJQUFJO2dCQUM1RCxJQUFJLEtBQUssR0FBRyxFQUFFLENBQUM7Z0JBQ2YsR0FBRyxDQUFBLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztvQkFDbEIsS0FBSyxDQUFDLElBQUksQ0FBQzt3QkFDUCxJQUFJLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDbEIsV0FBVyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3pCLFVBQVUsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO3FCQUMzQixDQUFDLENBQUM7Z0JBQ1AsQ0FBQztnQkFDRCxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkIsQ0FBQyxFQUFFLFVBQUEsS0FBSztnQkFDSixNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbEIsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFHTSx5Q0FBdUIsR0FBOUIsVUFBK0IsSUFBVTtRQUF6QyxpQkE2QkM7UUE1QkcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDL0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0IsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFDL0IsS0FBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMseUZBQXlGLEVBQzNHLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUEsSUFBSTtnQkFDN0IsSUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDO2dCQUNaLEdBQUcsQ0FBQSxDQUFDLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQ2xCLEtBQUssQ0FBQyxJQUFJLENBQUM7d0JBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ2xCLFdBQVcsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUN6QixVQUFVLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDeEIsVUFBVSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3hCLGNBQWMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO3FCQUMvQixDQUFDLENBQUM7Z0JBQ1AsQ0FBQztnQkFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUN2QixFQUFFLENBQUEsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2xCLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDbkIsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDSixNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2pCLENBQUM7WUFDTCxDQUFDLEVBQUUsVUFBQSxLQUFLO2dCQUVKLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsQ0FBQztnQkFDaEMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2pCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU0sMkJBQVMsR0FBaEIsVUFBaUIsSUFBVTtRQUEzQixpQkF1QkM7UUF0QkcsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU07WUFDL0IsS0FBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsNEdBQTRHLEVBQzlILENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQSxJQUFJO2dCQUM1QyxJQUFJLEtBQUssR0FBRyxFQUFFLENBQUM7Z0JBQ1osR0FBRyxDQUFBLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztvQkFDbEIsS0FBSyxDQUFDLElBQUksQ0FBQzt3QkFDUCxJQUFJLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDbEIsV0FBVyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3pCLFVBQVUsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUN4QixVQUFVLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDeEIsY0FBYyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7cUJBQy9CLENBQUMsQ0FBQztnQkFDUCxDQUFDO2dCQUNELEVBQUUsQ0FBQSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDbEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNuQixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDakIsQ0FBQztZQUNMLENBQUMsRUFBRSxVQUFBLEtBQUs7Z0JBQ0osTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2pCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU0sMEJBQVEsR0FBZjtRQUFBLGlCQW9CQztRQW5CRyxNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtZQUMvQixLQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxrRUFBa0UsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUk7Z0JBQy9GLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztnQkFDWCxHQUFHLENBQUEsQ0FBQyxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO29CQUNsQixLQUFLLENBQUMsSUFBSSxDQUFDO3dCQUVYLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUNsQixXQUFXLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDekIsVUFBVSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3hCLFVBQVUsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUN4QixjQUFjLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztxQkFDM0IsQ0FBQyxDQUFDO2dCQUNQLENBQUM7Z0JBQ0QsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ25CLENBQUMsRUFBRSxVQUFBLEtBQUs7Z0JBQ0osT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ25DLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNmLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUwsY0FBQztBQUFELENBQUMsQUFySUQsSUFxSUM7QUFySVksT0FBTztJQURuQixpQkFBVSxFQUFFOztHQUNBLE9BQU8sQ0FxSW5CO0FBcklZLDBCQUFPIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IFVzZXIgfSBmcm9tIFwiLi4vZG9tYWluL3VzZXJcIjtcbmltcG9ydCB7IENvbmZpZyB9IGZyb20gXCIuLi9jb25maWdcIjtcblxudmFyIFNxbGl0ZSA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtc3FsaXRlXCIpO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVXNlckRhbyB7XG5cbiAgICBwcml2YXRlIGRhdGFiYXNlOiBhbnk7XG4gICAgcHJpdmF0ZSBpc0luc3RhbnRpYXRlZDogYm9vbGVhbjtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBpZighdGhpcy5pc0luc3RhbnRpYXRlZCkge1xuICAgICAgICAgICAgKG5ldyBTcWxpdGUoQ29uZmlnLmRhdGFiYXNlTmFtZSkpLnRoZW4oZGIgPT4ge1xuICAgICAgICAgICAgICAgIGRiLmV4ZWNTUUwoYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHVzZXIgKGlkIElOVEVHRVIgUFJJTUFSWSBLRVkgQVVUT0lOQ1JFTUVOVCwgdXNlcm5hbWUgVEVYVCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWFpbEFkZHJlc3MgVEVYVCwgcGFzc3dvcmQgVEVYVCwgZmlyc3RuYW1lIFRFWFQsIGxhc3RuYW1lIFRFWFQsIHJvbGVJZCBJTlRFR0VSLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZPUkVJR04gS0VZKHJvbGVJZCkgUkVGRVJFTkNFUyByb2xlKGlkKSlcbiAgICAgICAgICAgICAgICBgKS50aGVuKGlkID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYXRhYmFzZSA9IGRiO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmlzSW5zdGFudGlhdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiQ1JFQVRFIFRBQkxFIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIk9QRU4gREIgRVJST1JcIiwgZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgaW5zZXJ0KHVzZXI6IFVzZXIpOiBQcm9taXNlPFVzZXI+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZGF0YWJhc2UuZXhlY1NRTChgSU5TRVJUIElOVE8gdXNlciAodXNlcm5hbWUsIGVtYWlsQWRkcmVzcywgcGFzc3dvcmQsIGZpcnN0bmFtZSwgbGFzdG5hbWUpIFZBTFVFUyAoPywgPywgPywgPywgPylgLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbdXNlci51c2VybmFtZSwgdXNlci5lbWFpbEFkZHJlc3MsIHVzZXIucGFzc3dvcmQsIHVzZXIuZmlyc3RuYW1lLCB1c2VyLmxhc3RuYW1lXSlcbiAgICAgICAgICAgIC50aGVuKGlkID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIklOU0VSVCBSRVNVTFRcIiwgaWQpO1xuICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcy5mZXRjaFVzZXJCeUlkKGlkKSk7XG4gICAgICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJJTlNFUlQgRVJST1JcIiwgZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBmZXRjaFVzZXJCeUlkKGlkOiBhbnkpOiBQcm9taXNlPFVzZXI+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgdGhpcy5kYXRhYmFzZS5hbGwoXCJTRUxFQ1QgKiBGUk9NIHVzZXIgd2hlcmUgaWQgPSA/XCIsIFtpZF0pLnRoZW4ocm93cyA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHVzZXJzID0gW107XG4gICAgICAgICAgICAgICAgZm9yKHZhciByb3cgaW4gcm93cykge1xuICAgICAgICAgICAgICAgICAgICB1c2Vycy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiaWRcIjogcm93c1tyb3ddWzBdLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJmaXJzdG5hbWVcIjogcm93c1tyb3ddWzFdLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJsYXN0bmFtZVwiOiByb3dzW3Jvd11bMl1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJlc29sdmUodXNlcnMpO1xuICAgICAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICBwdWJsaWMgZmV0Y2hVc2VyQnlFbWFpbEFkZHJlc3ModXNlcjogVXNlcik6IFByb21pc2U8VXNlcj4ge1xuICAgICAgICBjb25zb2xlLmxvZyh1c2VyLmVtYWlsQWRkcmVzcyk7XG4gICAgICAgIGNvbnNvbGUubG9nKHVzZXIudXNlcm5hbWUpO1xuICAgICAgICBjb25zb2xlLmxvZyh1c2VyLnBhc3N3b3JkKTtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZGF0YWJhc2UuYWxsKFwiU0VMRUNUIGlkLCBmaXJzdG5hbWUsIGxhc3RuYW1lLCB1c2VybmFtZSwgZW1haWxBZGRyZXNzIEZST00gdXNlciB3aGVyZSBlbWFpbEFkZHJlc3MgPSA/XCIsXG4gICAgICAgICAgICBbdXNlci5lbWFpbEFkZHJlc3NdKS50aGVuKHJvd3MgPT4ge1xuICAgICAgICAgICAgIGxldCB1c2VycyA9IFtdO1xuICAgICAgICAgICAgICAgIGZvcih2YXIgcm93IGluIHJvd3MpIHtcbiAgICAgICAgICAgICAgICAgICAgdXNlcnMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBcImlkXCI6IHJvd3Nbcm93XVswXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiZmlyc3RuYW1lXCI6IHJvd3Nbcm93XVsxXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwibGFzdG5hbWVcIjogcm93c1tyb3ddWzJdLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJ1c2VybmFtZVwiOiByb3dzW3Jvd11bM10sXG4gICAgICAgICAgICAgICAgICAgICAgICBcImVtYWlsQWRkcmVzc1wiOiByb3dzW3Jvd11bNF1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiSU0gSEVSRVwiKTtcbiAgICAgICAgICAgICAgICBpZih1c2Vycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUodXNlcnMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChudWxsKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCBlcnJvciA9PiB7XG5cbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIklNIEhFUkUgUkVKRUNURURcIik7XG4gICAgICAgICAgICAgICAgcmVqZWN0KG51bGwpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBmZXRjaFVzZXIodXNlcjogVXNlcik6IFByb21pc2U8VXNlcj4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5kYXRhYmFzZS5hbGwoXCJTRUxFQ1QgaWQsIGZpcnN0bmFtZSwgbGFzdG5hbWUsIHVzZXJuYW1lLCBlbWFpbEFkZHJlc3MgRlJPTSB1c2VyIHdoZXJlIChlbWFpbEFkZHJlc3MgPSA/KSBBTkQgcGFzc3dvcmQgPSA/XCIsXG4gICAgICAgICAgICBbdXNlci5lbWFpbEFkZHJlc3MsIHVzZXIucGFzc3dvcmRdKS50aGVuKHJvd3MgPT4ge1xuICAgICAgICAgICAgIGxldCB1c2VycyA9IFtdO1xuICAgICAgICAgICAgICAgIGZvcih2YXIgcm93IGluIHJvd3MpIHtcbiAgICAgICAgICAgICAgICAgICAgdXNlcnMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBcImlkXCI6IHJvd3Nbcm93XVswXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiZmlyc3RuYW1lXCI6IHJvd3Nbcm93XVsxXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFwibGFzdG5hbWVcIjogcm93c1tyb3ddWzJdLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJ1c2VybmFtZVwiOiByb3dzW3Jvd11bM10sXG4gICAgICAgICAgICAgICAgICAgICAgICBcImVtYWlsQWRkcmVzc1wiOiByb3dzW3Jvd11bNF1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmKHVzZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh1c2Vycyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG51bGwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QobnVsbCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGZldGNoQWxsKCk6IFByb21pc2U8QXJyYXk8VXNlcj4+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZGF0YWJhc2UuYWxsKFwiU0VMRUNUIGlkLCBmaXJzdG5hbWUsIGxhc3RuYW1lLCB1c2VybmFtZSwgZW1haWxBZGRyZXNzIEZST00gdXNlclwiKS50aGVuKHJvd3MgPT4ge1xuICAgICAgICAgICAgbGV0IHVzZXJzID0gW107XG4gICAgICAgICAgICAgICAgZm9yKHZhciByb3cgaW4gcm93cykge1xuICAgICAgICAgICAgICAgICAgICB1c2Vycy5wdXNoKHtcblxuICAgICAgICAgICAgICAgICAgICBcImlkXCI6IHJvd3Nbcm93XVswXSxcbiAgICAgICAgICAgICAgICAgICAgXCJmaXJzdG5hbWVcIjogcm93c1tyb3ddWzFdLFxuICAgICAgICAgICAgICAgICAgICBcImxhc3RuYW1lXCI6IHJvd3Nbcm93XVsyXSxcbiAgICAgICAgICAgICAgICAgICAgXCJ1c2VybmFtZVwiOiByb3dzW3Jvd11bM10sXG4gICAgICAgICAgICAgICAgICAgIFwiZW1haWxBZGRyZXNzXCI6IHJvd3Nbcm93XVs0XSxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJlc29sdmUodXNlcnMpO1xuICAgICAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU0VMRUNUIEVSUk9SXCIsIGVycm9yKTtcbiAgICAgICAgICAgICAgICByZWplY3QoW10pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxufSJdfQ==